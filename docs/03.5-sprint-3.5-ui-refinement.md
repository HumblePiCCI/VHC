# Sprint 3.5: UI/UX Refinement

**Status:** âœ… **COMPLETE** (Dec 7, 2025) | **Predecessor:** Sprint 3 âœ…
**Goal:** Polish HERMES Messaging + Forum UI/UX before Sprint 4

---

## 1. Guiding Principles

1. **Polish Over Features:** No new functionality â€” refinement only
2. **User-Driven:** Issues from real usage testing
3. **Light Touch:** Minimal code, maximum UX impact
4. **No Regressions:** All existing tests must pass

### 1.1 Engineering Discipline (`ARCHITECTURE_LOCK.md`)

- [x] **LOC Cap:** 350 lines/file âœ… (max 212 lines)
- [x] **Coverage:** 100% Line/Branch âœ… (291 tests)
- [x] **Browser-Safe:** No `node:*` imports, CSS-only animations âœ…
- [x] **E2E Mode:** Works with `VITE_E2E_MODE=true` âœ…
- [ ] **Accessibility:** Lighthouse A11y â‰¥ 90

### 1.2 Privacy Alignment (`System_Architecture.md`)

**Handles:** Local-first, opt-in sharing via QR/copy, NOT in public directory
**Constituency:** Per-user proofs stay local; only global aggregates shown; **N=20** cohort threshold
**"Other Districts":** **DEFERRED to Sprint 4** (requires Guardian Node)

---

## 2. Forum UI Refinements

### 2.1 Debate-First Layout (Schema v1)

**Problem:** Linear thread with counterpoints bolted on creates duplication
**Solution:** **Concur/Counter columns** as primary layout at every level

**Schema Change:**
```typescript
// HermesCommentSchemaV1
stance: 'concur' | 'counter';  // NEW - every comment has a stance
type?: 'reply' | 'counterpoint';  // DEPRECATED (read-only for migration)
```

**Migration:** `z.union([V0, V1])` for reads; write only V1

**Files:** `packages/data-model/src/schemas/hermes/forum.ts`, `apps/web-pwa/src/store/forum/*`

### 2.2 VENN â†’ Forum Transition (3D Card Flip)

**Vision:** Article summary flips to reveal debate discussion. Headline stays anchored.

<details>
<summary>ğŸ“ Layout Diagrams (click to expand)</summary>

```
VENN Article View (FRONT)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Headline: "Climate Bill Passes Senate"                       â”‚ â† STAYS FIXED
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚   ARTICLE SUMMARY + BIAS TABLE                           â”‚ â”‚
â”‚ â”‚   [Frame: "Historic victory"] [Reframe: "Insufficient"]  â”‚ â”‚ â† FLIPS
â”‚ â”‚   [ğŸ’¬ Discuss in Forum]                                  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ 3D Card Flip â†“
Forum Discussion View (BACK)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Headline: "Climate Bill Passes Senate"                       â”‚ â† SAME
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚   COMMUNITY REACTION SUMMARY                             â”‚ â”‚
â”‚ â”‚   47 participants â€¢ 23 Concur, 24 Counter                â”‚ â”‚
â”‚ â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚ â”‚   â”‚ ğŸ‘ CONCUR (23)      â”‚ ğŸ‘ COUNTER (24)             â”‚  â”‚ â”‚
â”‚ â”‚   â”‚ [comment cards]     â”‚ [comment cards]             â”‚  â”‚ â”‚
â”‚ â”‚   â”‚ [+ Add Concur]      â”‚ [+ Add Counter]             â”‚  â”‚ â”‚
â”‚ â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚ â”‚   [â† Back to Analysis]                                   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Zoomed Comment (nested debate within):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ (dimmed backdrop â€” click to dismiss) â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â”‚
â”‚â–‘â–‘â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â–‘â–‘â”‚
â”‚â–‘â–‘â”‚  @alice â€¢ "Finally, logic prevails!"         [â–²12 â–¼]  â”‚â–‘â–‘â”‚
â”‚â–‘â–‘â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â–‘â–‘â”‚
â”‚â–‘â–‘â”‚  â”‚ ğŸ‘ CONCUR (8)    â”‚ ğŸ‘ COUNTER (4)                â”‚â”‚â–‘â–‘â”‚
â”‚â–‘â–‘â”‚  â”‚ [nested cards]   â”‚ [nested cards]                â”‚â”‚â–‘â–‘â”‚
â”‚â–‘â–‘â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â–‘â–‘â”‚
â”‚â–‘â–‘â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â–‘â–‘â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Stacked cards breadcrumb (3 levels deep):**
```
â”‚â–‘â–‘â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â–‘â–‘â”‚ â† Level 0
â”‚â–‘â–‘â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â–‘â–‘â”‚ â† Level 1
â”‚â–‘â–‘â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â–‘â–‘â”‚ â† Level 2
â”‚â–‘â–‘â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â–‘â–‘â”‚ â† Current (Level 3)
```

</details>

**Community Reaction Summary Components:**
1. **Global Metrics:** Participant count, Concur/Counter breakdown
2. **Your Contribution:** "You participated (Concur/Counter)" indicator
3. **AI Summary:** Local WebLLM synthesis (45s debounce + manual refresh)
4. **Action Buttons:** "Send to Rep", "Draft Proposal", "Start Project" â†’ modal "Coming in Sprint 4"
5. **District:** Placeholder with lock icon (DEFERRED)

**Files:** `FlippableCard.tsx`, `AnalysisView.tsx`, `CommunityReactionSummary.tsx`

### 2.3 Zoom Navigation

**Behavior:** Click comment â†’ CSS scale/z-index animation â†’ fills width â†’ shows nested Concur/Counter
- **Escape:** Zoom out one level
- **Backdrop click:** Return to root
- **Parent edge click:** Return to that level
- **Pills:** Collapsed comments show "ğŸ‘ 3 Concur" pills; expanded shows full columns

**Files:** `ZoomableCard.tsx`, `CommentCard.tsx`, `useZoomNavigation.ts`

---

## 3. Messaging UI Refinements

### 3.1 Layout & ID Chip
- Contact list left, conversation right
- **ID Chip:** Fixed at top, shows YOUR ID (QR/Copy)
- **Navbar icon:** ğŸ’¬ accessible from any page â†’ `/hermes/messages`

### 3.2 User Handles
- **Format:** Alphanumeric + underscore, 3-20 chars
- **Uniqueness:** Not enforced; duplicates show discriminator "(2)"
- **Privacy:** NOT in DirectoryEntry; only in QR/copy payload + local ContactRecord
- **Display:** `handle ?? displayName ?? truncated(nullifier)`

**Files:** `IDChip.tsx`, `ChannelList.tsx`, `useIdentity.ts`, `utils/handle.ts`

---

## 4. Routes (Simplified)

| Route | Content |
|-------|---------|
| `/hermes` | Forum feed (direct access) |
| `/hermes/$threadId` | Individual thread |
| `/hermes/messages` | Messages (via ğŸ’¬ icon) |

---

## 5. Accessibility & Performance

- [x] CSS-only animations (transform, opacity) â†’ 60fps âœ…
- [x] `prefers-reduced-motion` respected âœ…
- [x] `aria-expanded`, `aria-hidden`, `role="dialog"` on flip/zoom âœ…
- [x] Focus trap in modals, Escape key dismissal âœ…
- [ ] Lighthouse A11y â‰¥ 90

---

## 6. Implementation Summary

| Phase | Description | Status |
|-------|-------------|--------|
| 1 | Schema v1 (stance), Store selectors, Debate UI, Zoom hook | âœ… |
| 2a | User Handles, IDChip | âœ… |
| 2b | Navbar ğŸ’¬, Community Reaction Summary | âœ… |
| 3 | FlippableCard 3D animation | âœ… |
| 4 | Manual testing bug fixes | âœ… |
| 5 | CI & E2E fixes | âœ… |

**Test Status:** 291 unit + 10 E2E passing | 100% coverage | CI green âœ…

<details>
<summary>ğŸ“‹ Phase Implementation Details (click to expand)</summary>

### Phase 1: Schema & Debate Layout (Dec 7)
- `HermesCommentSchemaV0` (deprecated) + `HermesCommentSchemaV1` (current)
- `z.union([V0, V1])` for reads, write only V1
- `migrateCommentToV1()` helper
- `getConcurComments()`, `getCounterComments()` selectors
- `CommentCard.tsx` (105 LOC), `DebateColumn.tsx` (51 LOC), `ZoomableCard.tsx` (67 LOC)
- `useZoomNavigation.ts` (31 LOC, 17 tests)

### Phase 2a: Handles & IDChip (Dec 7)
- `utils/handle.ts` â€” `isValidHandle()`, `getHandleError()`
- `useIdentity.ts` â€” handle field + `updateHandle()`
- `IDChip.tsx` (71 LOC) â€” replaces ContactQR
- `HandleEditor.tsx` (55 LOC) â€” extracted for LOC compliance

### Phase 2b: Navbar & Summary (Dec 7)
- ğŸ’¬ in header â†’ `/hermes/messages`
- `CommunityReactionSummary.tsx` (212 LOC)
- AI summary with 45s debounce + manual refresh
- Action button modals with a11y

### Phase 3: FlippableCard (Dec 7)
- `FlippableCard.tsx` (72 LOC)
- CSS `rotateY(180deg)`, `perspective: 1000px`
- `AnalysisView.tsx` integration

### Phase 4: Bug Fixes (Dec 7)
- **Infinite loop:** Added `subscribedThreads` Set to prevent duplicate subscriptions
- **Selector stability:** Use `EMPTY_COMMENTS` constant instead of `?? []`
- **Comment posting:** Always call `createComment()` before `onSubmit()`
- **Multi-zoom:** Only trigger `onSelect` when `!isExpanded`
- **Pills:** Show count pills collapsed, full content expanded
- **Navigation:** Forum loads at `/hermes` directly

### Phase 5: CI/E2E (Dec 7)
- Added `@vh/ai-engine` alias to `vitest.config.ts`
- Updated E2E tests: handle field, route changes, IDChip testids

</details>

---

## 7. Testing Checklist

### Forum
- [x] Two columns (Concur/Counter) display âœ…
- [x] Community Summary shows metrics âœ…
- [x] Zoom fills width, shows nested debate âœ…
- [x] Stacked cards breadcrumb âœ…
- [x] 3D flip VENN â†’ Forum âœ…
- [x] Add comments from zoomed view âœ…
- [ ] Vote persistence

### Messaging
- [x] ID Chip fixed at top âœ…
- [x] ğŸ’¬ navbar icon âœ…
- [x] Handle display with discriminators âœ…

### Regression
- [x] 291 unit tests âœ…
- [x] 10 E2E tests âœ…
- [x] 100% coverage âœ…

---

## 8. Key Decisions Log

| Decision | Rationale |
|----------|-----------|
| `stance` replaces `type` | Mirrors VENN bias table; eliminates duplication |
| N=20 cohort threshold | Per `spec-data-topology-privacy-v0.md` |
| "Other Districts" deferred | Requires Guardian Node for privacy |
| Handles NOT in directory | Privacy: local-only, QR exchange |
| Action buttons â†’ modal | Accessibility > disabled buttons |
| 45s AI debounce | Prevent thrashing local WebLLM |

<details>
<summary>ğŸ“ Session Notes Archive (click to expand)</summary>

### Session 1 (Dec 6)
- Issue 2.1: Comment/Counterpoint duplication â†’ debate-first layout
- Issue 2.2: Need VENN â†’ Forum transition â†’ 3D flip
- Issue 2.3: Nested zoom pattern â†’ CSS animation + backdrop
- Issue 3.1: Messaging layout â†’ contacts left, ID Chip fixed
- Issue 3.2: Need handles â†’ alphanumeric 3-20 chars

### Review Rounds (Dec 7)
**Round 1 (Codex + Gemini):** CONDITIONAL GO
- Cut: "Other Districts", handle in directory
- Keep: Debate layout, flip, zoom, handles (local), global metrics

**Round 2:** GO â€” all concerns addressed

### Manual Testing (Dec 7)
Issues found & fixed:
1. Infinite loop (subscription duplication)
2. Comments not appearing (onSubmit bypassed createComment)
3. Multi-zoom not working (expanded card re-zooming)
4. Needed pills for collapsed state
5. Navigation too cluttered â†’ simplified routes

</details>

---

## 9. Exit Criteria âœ…

- [x] All issues resolved âœ…
- [x] LOC cap maintained (max 212) âœ…
- [x] 100% coverage âœ…
- [x] E2E mode works âœ…
- [x] Manual tests pass âœ…
- [x] CI green âœ…
- [ ] Lighthouse A11y â‰¥ 90 (pending)

**Ready for:** Sprint 4 (Bridge) or additional 3.5 polish
